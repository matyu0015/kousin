<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚­ãƒ³ãƒˆãƒ¼ãƒ³CSVä¸€æ‹¬æ›´æ–°ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .description {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .step {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
        }

        .step-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .step-number {
            background: #4CAF50;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
        }

        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        input[type="file"]:hover {
            border-color: #4CAF50;
        }

        textarea, input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        select {
            cursor: pointer;
            background: white;
        }

        select:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .update-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .update-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .update-item-label {
            grid-column: 1 / -1;
            font-weight: 500;
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .add-item-btn {
            background: #2196F3;
            padding: 8px 16px;
            font-size: 14px;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .add-item-btn:hover {
            background: #1976D2;
        }

        .add-item-btn:disabled {
            background: #ccc;
        }

        .hidden {
            display: none;
        }

        .pattern-container {
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
        }

        .pattern-header {
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e3f2fd;
        }

        .add-pattern-btn {
            background: #FF9800;
            padding: 10px 20px;
            font-size: 15px;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .add-pattern-btn:hover {
            background: #F57C00;
        }

        .info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 13px;
            color: #1976d2;
        }

        .success {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .error {
            background: #ffcdd2;
            color: #c62828;
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ã‚­ãƒ³ãƒˆãƒ¼ãƒ³CSVä¸€æ‹¬æ›´æ–°ãƒ„ãƒ¼ãƒ«</h1>

        <!-- Step 1: CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
        <div class="step">
            <div class="step-title">
                <span class="step-number">1</span>
                ã‚­ãƒ³ãƒˆãƒ¼ãƒ³CSVãƒ‡ãƒ¼ã‚¿ã¯ã“ã¡ã‚‰
            </div>
            <div class="input-group">
                <label for="encoding">æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</label>
                <select id="encoding">
                    <option value="Shift_JIS">Shift_JISï¼ˆWindowsã®å ´åˆï¼‰</option>
                    <option value="UTF-8">UTF-8ï¼ˆMacã®å ´åˆï¼‰</option>
                </select>
                <div class="info" style="margin-top: 10px;">
                    ğŸ’¡ Windowsç’°å¢ƒã®CSVã¯ã€ŒShift_JISã€<br>
                    Macç’°å¢ƒã‚„UTF-8ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸå ´åˆã¯ã€ŒUTF-8ã€ã‚’é¸æŠã—ã¦ã­ã€‚ğŸ»
                </div>
            </div>
            <input type="file" id="csvFile" accept=".csv" />
            <div id="fileInfo" class="file-info" style="display: none;"></div>
        </div>

        <!-- Step 2: IDåˆ—åé¸æŠ -->
        <div class="step">
            <div class="step-title">
                <span class="step-number">2</span>
                IDåˆ—åã‚’é¸æŠ
            </div>
            <div class="input-group">
                <label for="idColumn">IDåˆ—å</label>
                <select id="idColumn" disabled>
                    <option value="">CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</option>
                </select>
            </div>
        </div>

        <!-- Step 3: æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
        <div class="step">
            <div class="step-title">
                <span class="step-number">3</span>
                æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®š
            </div>

            <!-- æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³1 -->
            <div class="pattern-container" id="pattern1">
                <div class="pattern-header">ğŸ“ æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³ 1</div>

                <div class="input-group">
                    <label for="targetIds1">æ›´æ–°ã—ãŸã„IDï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</label>
                    <textarea id="targetIds1" placeholder="A001&#10;A002&#10;A003"></textarea>
                </div>

                <!-- æ›´æ–°é …ç›®1-1 -->
                <div class="update-item">
                    <div class="update-item-label">æ›´æ–°é …ç›® 1</div>
                    <div class="input-group">
                        <label for="updateColumn1_1">æ›´æ–°ã™ã‚‹é …ç›®åï¼ˆåˆ—åï¼‰</label>
                        <select id="updateColumn1_1" disabled>
                            <option value="">CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue1_1">æ›´æ–°å†…å®¹</label>
                        <input type="text" id="updateValue1_1" placeholder="ä¾‹: åˆæ ¼" />
                    </div>
                </div>

                <!-- æ›´æ–°é …ç›®1-2 -->
                <div class="update-item hidden" id="updateItem1_2">
                    <div class="update-item-label">æ›´æ–°é …ç›® 2</div>
                    <div class="input-group">
                        <label for="updateColumn1_2">æ›´æ–°ã™ã‚‹é …ç›®åï¼ˆåˆ—åï¼‰</label>
                        <select id="updateColumn1_2" disabled>
                            <option value="">CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue1_2">æ›´æ–°å†…å®¹</label>
                        <input type="text" id="updateValue1_2" placeholder="ä¾‹: 2025-10-29" />
                    </div>
                </div>

                <!-- æ›´æ–°é …ç›®1-3 -->
                <div class="update-item hidden" id="updateItem1_3">
                    <div class="update-item-label">æ›´æ–°é …ç›® 3</div>
                    <div class="input-group">
                        <label for="updateColumn1_3">æ›´æ–°ã™ã‚‹é …ç›®åï¼ˆåˆ—åï¼‰</label>
                        <select id="updateColumn1_3" disabled>
                            <option value="">CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue1_3">æ›´æ–°å†…å®¹</label>
                        <input type="text" id="updateValue1_3" placeholder="ä¾‹: æ¸ˆ" />
                    </div>
                </div>

                <button class="add-item-btn" id="addItemBtn1" onclick="addUpdateItem(1)" type="button">â• æ›´æ–°é …ç›®ã‚’è¿½åŠ </button>
            </div>

            <!-- æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³2 -->
            <div class="pattern-container hidden" id="pattern2">
                <div class="pattern-header">ğŸ“ æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³ 2</div>

                <div class="input-group">
                    <label for="targetIds2">æ›´æ–°ã—ãŸã„IDï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</label>
                    <textarea id="targetIds2" placeholder="A006&#10;A009"></textarea>
                </div>

                <!-- æ›´æ–°é …ç›®2-1 -->
                <div class="update-item">
                    <div class="update-item-label">æ›´æ–°é …ç›® 1</div>
                    <div class="input-group">
                        <label for="updateColumn2_1">æ›´æ–°ã™ã‚‹é …ç›®åï¼ˆåˆ—åï¼‰</label>
                        <select id="updateColumn2_1" disabled>
                            <option value="">CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue2_1">æ›´æ–°å†…å®¹</label>
                        <input type="text" id="updateValue2_1" placeholder="ä¾‹: ä¸åˆæ ¼" />
                    </div>
                </div>

                <!-- æ›´æ–°é …ç›®2-2 -->
                <div class="update-item hidden" id="updateItem2_2">
                    <div class="update-item-label">æ›´æ–°é …ç›® 2</div>
                    <div class="input-group">
                        <label for="updateColumn2_2">æ›´æ–°ã™ã‚‹é …ç›®åï¼ˆåˆ—åï¼‰</label>
                        <select id="updateColumn2_2" disabled>
                            <option value="">CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue2_2">æ›´æ–°å†…å®¹</label>
                        <input type="text" id="updateValue2_2" placeholder="ä¾‹: 2025-10-29" />
                    </div>
                </div>

                <!-- æ›´æ–°é …ç›®2-3 -->
                <div class="update-item hidden" id="updateItem2_3">
                    <div class="update-item-label">æ›´æ–°é …ç›® 3</div>
                    <div class="input-group">
                        <label for="updateColumn2_3">æ›´æ–°ã™ã‚‹é …ç›®åï¼ˆåˆ—åï¼‰</label>
                        <select id="updateColumn2_3" disabled>
                            <option value="">CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue2_3">æ›´æ–°å†…å®¹</label>
                        <input type="text" id="updateValue2_3" placeholder="ä¾‹: æ¸ˆ" />
                    </div>
                </div>

                <button class="add-item-btn" id="addItemBtn2" onclick="addUpdateItem(2)" type="button">â• æ›´æ–°é …ç›®ã‚’è¿½åŠ </button>
            </div>

            <button class="add-pattern-btn" id="addPatternBtn" onclick="addPattern()" type="button">â• æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ </button>

            <div class="info" style="margin-top: 15px;">
                â€» é•ã†IDæ›´æ–°ã®å ´åˆã¯ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­
            </div>
        </div>

        <!-- Step 4: å®Ÿè¡Œ -->
        <div class="step">
            <div class="step-title">
                <span class="step-number">4</span>
                æ›´æ–°æ¸ˆã¿CSVã‚’å‡ºåŠ›
            </div>
            <button id="updateBtn" onclick="updateCSV()">CSVã‚’æ›´æ–°ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <div id="result" class="info" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        let csvData = [];
        let headers = [];
        let currentItemCount = {1: 1, 2: 1}; // å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹æ›´æ–°é …ç›®ã®æ•°
        let currentPatternCount = 1; // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ•°

        // CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // é¸æŠã•ã‚ŒãŸã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å–å¾—
            const encoding = document.getElementById('encoding').value;

            const reader = new FileReader();
            reader.onload = function(event) {
                const text = event.target.result;
                parseCSV(text);

                const fileInfo = document.getElementById('fileInfo');
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `ğŸ“„ <strong>${file.name}</strong> ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${encoding}ï¼‰<br>ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${csvData.length}ä»¶ / åˆ—æ•°: ${headers.length}`;

                // åˆ—åã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
                populateColumnSelects();
            };
            reader.readAsText(file, encoding);
        });

        // IDåˆ—ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«æ›´æ–°é …ç›®ã®é¸æŠè‚¢ã‚’æ›´æ–°
        document.getElementById('idColumn').addEventListener('change', function() {
            updateColumnOptions();
        });

        // CSVè§£æï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            if (lines.length === 0) return;

            headers = parseCSVLine(lines[0]);
            csvData = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    csvData.push(row);
                }
            }
        }

        // CSVè¡Œè§£æï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // åˆ—åã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
        function populateColumnSelects() {
            const idColumnSelect = document.getElementById('idColumn');

            // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
            idColumnSelect.innerHTML = '';

            // IDåˆ—ã®é¸æŠè‚¢ã‚’è¿½åŠ 
            headers.forEach(header => {
                const optionId = document.createElement('option');
                optionId.value = header;
                optionId.textContent = header;
                idColumnSelect.appendChild(optionId);
            });

            // ã‚»ãƒ¬ã‚¯ãƒˆã‚’æœ‰åŠ¹åŒ–
            idColumnSelect.disabled = false;

            // æ›´æ–°é …ç›®ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
            updateColumnOptions();
        }

        // æ›´æ–°é …ç›®ã®é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆIDåˆ—ã‚’é™¤å¤–ï¼‰
        function updateColumnOptions() {
            const idColumn = document.getElementById('idColumn').value;

            // ãƒ‘ã‚¿ãƒ¼ãƒ³1ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³2ã®å…¨ã¦ã®é¸æŠè‚¢ã‚’æ›´æ–°
            for (let p = 1; p <= 2; p++) {
                for (let i = 1; i <= 3; i++) {
                    const selectId = `updateColumn${p}_${i}`;
                    const selectElement = document.getElementById(selectId);
                    if (!selectElement) continue;

                    // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
                    selectElement.innerHTML = '';

                    // é …ç›®2ã¨3ã«ã¯ã€Œï¼ˆæ›´æ–°ã—ãªã„ï¼‰ã€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¿½åŠ 
                    if (i >= 2) {
                        const emptyOption = document.createElement('option');
                        emptyOption.value = '';
                        emptyOption.textContent = 'ï¼ˆæ›´æ–°ã—ãªã„ï¼‰';
                        selectElement.appendChild(emptyOption);
                    }

                    // IDåˆ—ä»¥å¤–ã®åˆ—ã‚’é¸æŠè‚¢ã«è¿½åŠ 
                    headers.forEach(header => {
                        if (header !== idColumn) {
                            const option = document.createElement('option');
                            option.value = header;
                            option.textContent = header;
                            selectElement.appendChild(option);
                        }
                    });

                    // ã‚»ãƒ¬ã‚¯ãƒˆã‚’æœ‰åŠ¹åŒ–
                    selectElement.disabled = false;
                }
            }
        }

        // æ›´æ–°é …ç›®ã‚’è¿½åŠ è¡¨ç¤º
        function addUpdateItem(patternNum) {
            if (currentItemCount[patternNum] === 1) {
                document.getElementById(`updateItem${patternNum}_2`).classList.remove('hidden');
                currentItemCount[patternNum] = 2;
            } else if (currentItemCount[patternNum] === 2) {
                document.getElementById(`updateItem${patternNum}_3`).classList.remove('hidden');
                currentItemCount[patternNum] = 3;
                // 3ã¤è¡¨ç¤ºã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                document.getElementById(`addItemBtn${patternNum}`).disabled = true;
                document.getElementById(`addItemBtn${patternNum}`).textContent = 'âœ“ ã™ã¹ã¦ã®é …ç›®ã‚’è¿½åŠ æ¸ˆã¿';
            }
        }

        // æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ è¡¨ç¤º
        function addPattern() {
            if (currentPatternCount === 1) {
                document.getElementById('pattern2').classList.remove('hidden');
                currentPatternCount = 2;
                // 2ã¤è¡¨ç¤ºã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                document.getElementById('addPatternBtn').disabled = true;
                document.getElementById('addPatternBtn').textContent = 'âœ“ ã™ã¹ã¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ æ¸ˆã¿';

                // ãƒ‘ã‚¿ãƒ¼ãƒ³2ã®é¸æŠè‚¢ã‚‚æ›´æ–°
                updateColumnOptions();
            }
        }

        // CSVæ›´æ–°å‡¦ç†
        function updateCSV() {
            const resultDiv = document.getElementById('result');

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (csvData.length === 0) {
                showResult('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            const idColumn = document.getElementById('idColumn').value.trim();

            // IDåˆ—ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if (!idColumn) {
                showResult('IDåˆ—åã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!headers.includes(idColumn)) {
                showResult(`ã‚¨ãƒ©ãƒ¼: åˆ—ã€Œ${idColumn}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br>åˆ©ç”¨å¯èƒ½ãªåˆ—: ${headers.join(', ')}`, 'error');
                return;
            }

            // å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†
            const patterns = [];
            const updatedIdSet = new Set(); // æ›´æ–°ã•ã‚ŒãŸIDã‚’è¨˜éŒ²

            for (let p = 1; p <= currentPatternCount; p++) {
                const targetIdsText = document.getElementById(`targetIds${p}`).value.trim();

                // IDãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (!targetIdsText) {
                    if (p === 1) {
                        showResult('ãƒ‘ã‚¿ãƒ¼ãƒ³1ã®æ›´æ–°ã—ãŸã„IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                        return;
                    }
                    continue;
                }

                const targetIds = targetIdsText.split(/\r?\n/).map(id => id.trim()).filter(id => id);

                // æ›´æ–°é …ç›®ã‚’åé›†
                const updateItems = [];
                for (let i = 1; i <= 3; i++) {
                    const updateColumn = document.getElementById(`updateColumn${p}_${i}`).value.trim();
                    const updateValue = document.getElementById(`updateValue${p}_${i}`).value;

                    if (i === 1 && !updateColumn) {
                        showResult(`ãƒ‘ã‚¿ãƒ¼ãƒ³${p}ã®æ›´æ–°é …ç›®1ã¯å¿…é ˆã§ã™`, 'error');
                        return;
                    }

                    if (updateColumn && updateColumn !== '') {
                        if (!headers.includes(updateColumn)) {
                            showResult(`ãƒ‘ã‚¿ãƒ¼ãƒ³${p}: ã‚¨ãƒ©ãƒ¼ - åˆ—ã€Œ${updateColumn}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'error');
                            return;
                        }

                        // åˆ—ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ãŒå€¤ãŒç©ºã®å ´åˆã¯è­¦å‘Šï¼ˆé …ç›®2,3ã®ã¿ï¼‰
                        if (i >= 2 && updateValue.trim() === '') {
                            showResult(`ãƒ‘ã‚¿ãƒ¼ãƒ³${p}: è­¦å‘Š - æ›´æ–°é …ç›®${i}ã§åˆ—ã€Œ${updateColumn}ã€ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ãŒã€æ›´æ–°å†…å®¹ãŒç©ºã§ã™ã€‚`, 'error');
                            return;
                        }

                        updateItems.push({ column: updateColumn, value: updateValue });
                    }
                }

                patterns.push({
                    patternNum: p,
                    targetIds: targetIds,
                    updateItems: updateItems
                });
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            const updatedRows = [];
            let totalUpdateCount = 0;
            const patternSummary = [];

            patterns.forEach(pattern => {
                let patternUpdateCount = 0;

                csvData.forEach(row => {
                    if (pattern.targetIds.includes(row[idColumn])) {
                        // è¤‡æ•°é …ç›®ã‚’æ›´æ–°
                        pattern.updateItems.forEach(item => {
                            row[item.column] = item.value;
                        });

                        // ã¾ã è¿½åŠ ã•ã‚Œã¦ã„ãªã„IDã®å ´åˆã®ã¿è¿½åŠ 
                        if (!updatedIdSet.has(row[idColumn])) {
                            updatedRows.push(row);
                            updatedIdSet.add(row[idColumn]);
                        }

                        patternUpdateCount++;
                    }
                });

                const updatedColumns = pattern.updateItems.map(item => item.column).join(', ');
                patternSummary.push(`ãƒ‘ã‚¿ãƒ¼ãƒ³${pattern.patternNum}: ${patternUpdateCount}ä»¶ï¼ˆ${updatedColumns}ï¼‰`);
                totalUpdateCount += patternUpdateCount;
            });

            if (totalUpdateCount === 0) {
                showResult(`è­¦å‘Š: è©²å½“ã™ã‚‹IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`, 'error');
                return;
            }

            // CSVå‡ºåŠ›ï¼ˆæ›´æ–°ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ï¼‰
            const csvContent = generateCSV(updatedRows);
            downloadCSV(csvContent, 'kintone_updated.csv');

            // çµæœè¡¨ç¤º
            const summaryHtml = patternSummary.join('<br>');
            showResult(`âœ“ åˆè¨ˆ ${updatedRows.length}ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼<br><br>${summaryHtml}`, 'success');
        }

        // CSVç”Ÿæˆ
        function generateCSV(dataRows) {
            const rows = [headers];
            dataRows.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    // ã‚«ãƒ³ãƒã‚„æ”¹è¡Œã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’å«ã‚€å ´åˆã¯ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
                    if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                        return '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                rows.push(values);
            });

            return rows.map(row => row.join(',')).join('\n');
        }

        // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCSV(content, filename) {
            const bom = '\uFEFF'; // UTF-8 BOMï¼ˆExcelã§æ–‡å­—åŒ–ã‘é˜²æ­¢ï¼‰
            const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // çµæœè¡¨ç¤º
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'info ' + type;
            resultDiv.innerHTML = message;
        }
    </script>
</body>
</html>
