<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>キントーンCSV一括更新ツール</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .description {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .step {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
        }

        .step-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .step-number {
            background: #4CAF50;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
        }

        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        input[type="file"]:hover {
            border-color: #4CAF50;
        }

        textarea, input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        select {
            cursor: pointer;
            background: white;
        }

        select:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .update-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .update-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .update-item-label {
            grid-column: 1 / -1;
            font-weight: 500;
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .add-item-btn {
            background: #2196F3;
            padding: 8px 16px;
            font-size: 14px;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .add-item-btn:hover {
            background: #1976D2;
        }

        .add-item-btn:disabled {
            background: #ccc;
        }

        .hidden {
            display: none;
        }

        .pattern-container {
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
        }

        .pattern-header {
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e3f2fd;
        }

        .add-pattern-btn {
            background: #FF9800;
            padding: 10px 20px;
            font-size: 15px;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .add-pattern-btn:hover {
            background: #F57C00;
        }

        .info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 13px;
            color: #1976d2;
        }

        .success {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .error {
            background: #ffcdd2;
            color: #c62828;
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>キントーンCSV一括更新ツール</h1>

        <!-- Step 1: CSVアップロード -->
        <div class="step">
            <div class="step-title">
                <span class="step-number">1</span>
                キントーンCSVデータはこちら
            </div>
            <div class="input-group">
                <label for="encoding">文字エンコーディング</label>
                <select id="encoding">
                    <option value="Shift_JIS">Shift_JIS（Windowsの場合）</option>
                    <option value="UTF-8">UTF-8（Macの場合）</option>
                </select>
                <div class="info" style="margin-top: 10px;">
                    💡 Windows環境のCSVは「Shift_JIS」<br>
                    Mac環境やUTF-8でエクスポートした場合は「UTF-8」を選択してね。🐻
                </div>
            </div>
            <input type="file" id="csvFile" accept=".csv" />
            <div id="fileInfo" class="file-info" style="display: none;"></div>
        </div>

        <!-- Step 2: ID列名選択 -->
        <div class="step">
            <div class="step-title">
                <span class="step-number">2</span>
                ID列名を選択
            </div>
            <div class="input-group">
                <label for="idColumn">ID列名</label>
                <select id="idColumn" disabled>
                    <option value="">CSVを読み込んでください</option>
                </select>
            </div>
        </div>

        <!-- Step 3: 更新パターン -->
        <div class="step">
            <div class="step-title">
                <span class="step-number">3</span>
                更新パターンを設定
            </div>

            <!-- 更新パターン1 -->
            <div class="pattern-container" id="pattern1">
                <div class="pattern-header">📝 更新パターン 1</div>

                <div class="input-group">
                    <label for="targetIds1">更新したいID（改行区切り）</label>
                    <textarea id="targetIds1" placeholder="A001&#10;A002&#10;A003"></textarea>
                </div>

                <!-- 更新項目1-1 -->
                <div class="update-item">
                    <div class="update-item-label">更新項目 1</div>
                    <div class="input-group">
                        <label for="updateColumn1_1">更新する項目名（列名）</label>
                        <select id="updateColumn1_1" disabled>
                            <option value="">CSVを読み込んでください</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue1_1">更新内容</label>
                        <input type="text" id="updateValue1_1" placeholder="例: 合格" />
                    </div>
                </div>

                <!-- 更新項目1-2 -->
                <div class="update-item hidden" id="updateItem1_2">
                    <div class="update-item-label">更新項目 2</div>
                    <div class="input-group">
                        <label for="updateColumn1_2">更新する項目名（列名）</label>
                        <select id="updateColumn1_2" disabled>
                            <option value="">CSVを読み込んでください</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue1_2">更新内容</label>
                        <input type="text" id="updateValue1_2" placeholder="例: 2025-10-29" />
                    </div>
                </div>

                <!-- 更新項目1-3 -->
                <div class="update-item hidden" id="updateItem1_3">
                    <div class="update-item-label">更新項目 3</div>
                    <div class="input-group">
                        <label for="updateColumn1_3">更新する項目名（列名）</label>
                        <select id="updateColumn1_3" disabled>
                            <option value="">CSVを読み込んでください</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue1_3">更新内容</label>
                        <input type="text" id="updateValue1_3" placeholder="例: 済" />
                    </div>
                </div>

                <button class="add-item-btn" id="addItemBtn1" onclick="addUpdateItem(1)" type="button">➕ 更新項目を追加</button>
            </div>

            <!-- 更新パターン2 -->
            <div class="pattern-container hidden" id="pattern2">
                <div class="pattern-header">📝 更新パターン 2</div>

                <div class="input-group">
                    <label for="targetIds2">更新したいID（改行区切り）</label>
                    <textarea id="targetIds2" placeholder="A006&#10;A009"></textarea>
                </div>

                <!-- 更新項目2-1 -->
                <div class="update-item">
                    <div class="update-item-label">更新項目 1</div>
                    <div class="input-group">
                        <label for="updateColumn2_1">更新する項目名（列名）</label>
                        <select id="updateColumn2_1" disabled>
                            <option value="">CSVを読み込んでください</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue2_1">更新内容</label>
                        <input type="text" id="updateValue2_1" placeholder="例: 不合格" />
                    </div>
                </div>

                <!-- 更新項目2-2 -->
                <div class="update-item hidden" id="updateItem2_2">
                    <div class="update-item-label">更新項目 2</div>
                    <div class="input-group">
                        <label for="updateColumn2_2">更新する項目名（列名）</label>
                        <select id="updateColumn2_2" disabled>
                            <option value="">CSVを読み込んでください</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue2_2">更新内容</label>
                        <input type="text" id="updateValue2_2" placeholder="例: 2025-10-29" />
                    </div>
                </div>

                <!-- 更新項目2-3 -->
                <div class="update-item hidden" id="updateItem2_3">
                    <div class="update-item-label">更新項目 3</div>
                    <div class="input-group">
                        <label for="updateColumn2_3">更新する項目名（列名）</label>
                        <select id="updateColumn2_3" disabled>
                            <option value="">CSVを読み込んでください</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="updateValue2_3">更新内容</label>
                        <input type="text" id="updateValue2_3" placeholder="例: 済" />
                    </div>
                </div>

                <button class="add-item-btn" id="addItemBtn2" onclick="addUpdateItem(2)" type="button">➕ 更新項目を追加</button>
            </div>

            <button class="add-pattern-btn" id="addPatternBtn" onclick="addPattern()" type="button">➕ 更新パターンを追加</button>

            <div class="info" style="margin-top: 15px;">
                ※ 違うID更新の場合はプラスボタンを押してね
            </div>
        </div>

        <!-- Step 4: 実行 -->
        <div class="step">
            <div class="step-title">
                <span class="step-number">4</span>
                更新済みCSVを出力
            </div>
            <button id="updateBtn" onclick="updateCSV()">CSVを更新してダウンロード</button>
            <div id="result" class="info" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        let csvData = [];
        let headers = [];
        let currentItemCount = {1: 1, 2: 1}; // 各パターンの現在表示している更新項目の数
        let currentPatternCount = 1; // 現在表示しているパターンの数

        // CSVファイル読み込み
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // 選択されたエンコーディングを取得
            const encoding = document.getElementById('encoding').value;

            const reader = new FileReader();
            reader.onload = function(event) {
                const text = event.target.result;
                parseCSV(text);

                const fileInfo = document.getElementById('fileInfo');
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `📄 <strong>${file.name}</strong> を読み込みました（${encoding}）<br>データ件数: ${csvData.length}件 / 列数: ${headers.length}`;

                // 列名の選択肢を生成
                populateColumnSelects();
            };
            reader.readAsText(file, encoding);
        });

        // ID列が変更されたときに更新項目の選択肢を更新
        document.getElementById('idColumn').addEventListener('change', function() {
            updateColumnOptions();
        });

        // CSV解析（シンプル版）
        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            if (lines.length === 0) return;

            headers = parseCSVLine(lines[0]);
            csvData = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    csvData.push(row);
                }
            }
        }

        // CSV行解析（カンマ区切り、ダブルクォート対応）
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // 列名の選択肢を生成
        function populateColumnSelects() {
            const idColumnSelect = document.getElementById('idColumn');

            // 既存の選択肢をクリア
            idColumnSelect.innerHTML = '';

            // ID列の選択肢を追加
            headers.forEach(header => {
                const optionId = document.createElement('option');
                optionId.value = header;
                optionId.textContent = header;
                idColumnSelect.appendChild(optionId);
            });

            // セレクトを有効化
            idColumnSelect.disabled = false;

            // 更新項目の選択肢を生成
            updateColumnOptions();
        }

        // 更新項目の選択肢を生成（ID列を除外）
        function updateColumnOptions() {
            const idColumn = document.getElementById('idColumn').value;

            // パターン1とパターン2の全ての選択肢を更新
            for (let p = 1; p <= 2; p++) {
                for (let i = 1; i <= 3; i++) {
                    const selectId = `updateColumn${p}_${i}`;
                    const selectElement = document.getElementById(selectId);
                    if (!selectElement) continue;

                    // 既存の選択肢をクリア
                    selectElement.innerHTML = '';

                    // 項目2と3には「（更新しない）」をデフォルトで追加
                    if (i >= 2) {
                        const emptyOption = document.createElement('option');
                        emptyOption.value = '';
                        emptyOption.textContent = '（更新しない）';
                        selectElement.appendChild(emptyOption);
                    }

                    // ID列以外の列を選択肢に追加
                    headers.forEach(header => {
                        if (header !== idColumn) {
                            const option = document.createElement('option');
                            option.value = header;
                            option.textContent = header;
                            selectElement.appendChild(option);
                        }
                    });

                    // セレクトを有効化
                    selectElement.disabled = false;
                }
            }
        }

        // 更新項目を追加表示
        function addUpdateItem(patternNum) {
            if (currentItemCount[patternNum] === 1) {
                document.getElementById(`updateItem${patternNum}_2`).classList.remove('hidden');
                currentItemCount[patternNum] = 2;
            } else if (currentItemCount[patternNum] === 2) {
                document.getElementById(`updateItem${patternNum}_3`).classList.remove('hidden');
                currentItemCount[patternNum] = 3;
                // 3つ表示したらボタンを無効化
                document.getElementById(`addItemBtn${patternNum}`).disabled = true;
                document.getElementById(`addItemBtn${patternNum}`).textContent = '✓ すべての項目を追加済み';
            }
        }

        // 更新パターンを追加表示
        function addPattern() {
            if (currentPatternCount === 1) {
                document.getElementById('pattern2').classList.remove('hidden');
                currentPatternCount = 2;
                // 2つ表示したらボタンを無効化
                document.getElementById('addPatternBtn').disabled = true;
                document.getElementById('addPatternBtn').textContent = '✓ すべてのパターンを追加済み';

                // パターン2の選択肢も更新
                updateColumnOptions();
            }
        }

        // CSV更新処理
        function updateCSV() {
            const resultDiv = document.getElementById('result');

            // バリデーション
            if (csvData.length === 0) {
                showResult('CSVファイルを読み込んでください', 'error');
                return;
            }

            const idColumn = document.getElementById('idColumn').value.trim();

            // ID列の存在チェック
            if (!idColumn) {
                showResult('ID列名を選択してください', 'error');
                return;
            }

            if (!headers.includes(idColumn)) {
                showResult(`エラー: 列「${idColumn}」が見つかりません<br>利用可能な列: ${headers.join(', ')}`, 'error');
                return;
            }

            // 各パターンを処理
            const patterns = [];
            const updatedIdSet = new Set(); // 更新されたIDを記録

            for (let p = 1; p <= currentPatternCount; p++) {
                const targetIdsText = document.getElementById(`targetIds${p}`).value.trim();

                // IDが入力されていない場合はスキップ
                if (!targetIdsText) {
                    if (p === 1) {
                        showResult('パターン1の更新したいIDを入力してください', 'error');
                        return;
                    }
                    continue;
                }

                const targetIds = targetIdsText.split(/\r?\n/).map(id => id.trim()).filter(id => id);

                // 更新項目を収集
                const updateItems = [];
                for (let i = 1; i <= 3; i++) {
                    const updateColumn = document.getElementById(`updateColumn${p}_${i}`).value.trim();
                    const updateValue = document.getElementById(`updateValue${p}_${i}`).value;

                    if (i === 1 && !updateColumn) {
                        showResult(`パターン${p}の更新項目1は必須です`, 'error');
                        return;
                    }

                    if (updateColumn && updateColumn !== '') {
                        if (!headers.includes(updateColumn)) {
                            showResult(`パターン${p}: エラー - 列「${updateColumn}」が見つかりません`, 'error');
                            return;
                        }

                        // 列が選択されているが値が空の場合は警告（項目2,3のみ）
                        if (i >= 2 && updateValue.trim() === '') {
                            showResult(`パターン${p}: 警告 - 更新項目${i}で列「${updateColumn}」が選択されていますが、更新内容が空です。`, 'error');
                            return;
                        }

                        updateItems.push({ column: updateColumn, value: updateValue });
                    }
                }

                patterns.push({
                    patternNum: p,
                    targetIds: targetIds,
                    updateItems: updateItems
                });
            }

            // データを更新
            const updatedRows = [];
            let totalUpdateCount = 0;
            const patternSummary = [];

            patterns.forEach(pattern => {
                let patternUpdateCount = 0;

                csvData.forEach(row => {
                    if (pattern.targetIds.includes(row[idColumn])) {
                        // 複数項目を更新
                        pattern.updateItems.forEach(item => {
                            row[item.column] = item.value;
                        });

                        // まだ追加されていないIDの場合のみ追加
                        if (!updatedIdSet.has(row[idColumn])) {
                            updatedRows.push(row);
                            updatedIdSet.add(row[idColumn]);
                        }

                        patternUpdateCount++;
                    }
                });

                const updatedColumns = pattern.updateItems.map(item => item.column).join(', ');
                patternSummary.push(`パターン${pattern.patternNum}: ${patternUpdateCount}件（${updatedColumns}）`);
                totalUpdateCount += patternUpdateCount;
            });

            if (totalUpdateCount === 0) {
                showResult(`警告: 該当するIDが見つかりませんでした`, 'error');
                return;
            }

            // CSV出力（更新したレコードのみ）
            const csvContent = generateCSV(updatedRows);
            downloadCSV(csvContent, 'kintone_updated.csv');

            // 結果表示
            const summaryHtml = patternSummary.join('<br>');
            showResult(`✓ 合計 ${updatedRows.length}件のレコードを更新しました！<br><br>${summaryHtml}`, 'success');
        }

        // CSV生成
        function generateCSV(dataRows) {
            const rows = [headers];
            dataRows.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    // カンマや改行、ダブルクォートを含む場合はクォートで囲む
                    if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                        return '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                rows.push(values);
            });

            return rows.map(row => row.join(',')).join('\n');
        }

        // CSVダウンロード
        function downloadCSV(content, filename) {
            const bom = '\uFEFF'; // UTF-8 BOM（Excelで文字化け防止）
            const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // 結果表示
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'info ' + type;
            resultDiv.innerHTML = message;
        }
    </script>
</body>
</html>
